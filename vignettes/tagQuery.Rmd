---
title: "Using tagQuery() to query and modify HTML tags"
output: html_document
---

```{r, include=FALSE}
library(knitr)
opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  out.width = "100%",
  fig.align = 'center'
)
# Show R console output instead of embedding the HTML
registerS3method(
  "knit_print", "shiny.tag", 
  function(x, ...) print.shiny.tag(x, browse = FALSE)
)
registerS3method(
  "knit_print", "shiny.tag.list", 
  function(x, ...) print.shiny.tag.list(x, browse = FALSE)
)
```

`tagQuery()` provides a [jQuery](https://jquery.com) inspired interface to query and modify HTML fragments in R. To start, pass either a `tag()` (e.g., `div()`) or `tagList()` object to `tagQuery()`:

```{r}
library(htmltools)
tagQuery(div(a()))
```

Notice how `tagQuery()` tracks two essential pieces: the _root_ (i.e., input) tag as well as _selected_ tags (by default the root is selected). This data structure allows us to [efficiently](#performance) [query](#query), [modify](#modify), and [replace](#replace) particular fragments of the root HTML tag.

Since `tagQuery()` isn't itself a `tag()` object, it can't be passed directly to `tag()` or tag rendering functions, but at any given time you can extract the `$root()` or `$selected()` tags.

## Query {#query}

`tagQuery()` has numerous methods to select (i.e., query) HTML tag(s). Every query method accepts a [CSS selector](https://developer.mozilla.org/en-US/docs/Learn/CSS/Building_blocks/Selectors) for targeting particular tags of interest. At the moment, `tagQuery()` only supports a combination of [type](https://www.w3.org/TR/CSS22/selector.html#type-selectors) (e.g, `div`), [class](https://www.w3.org/TR/CSS22/selector.html#class-html) (e.g., `.my-class`), [id](https://www.w3.org/TR/CSS22/selector.html#id-selectors) (e.g., `#myID`), and [universal](https://www.w3.org/TR/CSS22/selector.html#universal-selector) (`*`) selectors within a given [simple selector](https://www.w3.org/TR/CSS22/selector.html#selector-syntax).

### Children

To begin querying tags, start with either `$find()` or `$children()`. The former traverses _all_ descendants whereas the latter only considers _direct_ descendants.

```{r}
tagQ <- tagQuery(div(span("foo"), div(span("bar"))))
tagQ$find("span")$selected()
tagQ$children("span")$selected()
```

And since `$find()` considers all descendants, it allows for [descendant selectors](https://www.w3.org/TR/CSS22/selector.html#descendant-selectors) (space) and direct [child selectors](https://www.w3.org/TR/CSS22/selector.html#child-selectors) (>).

```{r}
tagQ <- tagQuery(div(div(span(a()))))
tagQ$find("div a")$selected()
tagQ$find("div > a")$selected()
tagQ$find("div > span > a")$selected()
```

Since `tagQuery()` methods may be chained together, you could also implement  `tagQ$find("div > span > a")` as:

```{r}
tagQ$find("div")$children("span")$children("a")$selected()
```

### Siblings

Although `tagQuery()` doesn't (currently) support [sibling selectors](https://www.w3schools.com/css/css_combinators.asp) (`+` and `~`), it does provide a `$sibling()` method, which provides essentially the same functionality:

```{r}
tagQ <- tagQuery(div(a(), span(), p()))
# The moral equivalent to `tagQ$find("a ~ span")`
tagQ$find("a")$siblings("span")$selected()
```

### Parents

In some cases, after finding children, it can be useful to traverse back up the tag tree to find particular ancestors of a selection. Similar to the difference in `$find()` and `$children()`, `$parents()` traverses _all_ ancestors whereas `$parent()` considers just _direct_ ancestors.

```{r}
tagQ <- tagQuery(
  div(
    div(a(class = "foo")),
    span(a())
  )
)
tagQ$find("a.foo")$parent()$selected()
tagQ$find("a.foo")$parents()$selected()
```

<!-- TODO: worth mentioning closest()? -->

### Filter

The `$filter()` method can be used to subset selected tags using an R function or CSS selector. When combined with the universal selector (`*`), `$filter()` is particularly useful as a workaround for the fact that `tagQuery()` doesn't fully support the entire CSS selector specification. For example, here's a workaround for `tagQuery()`'s current lack of support for [attribute selectors](https://www.w3.org/TR/CSS22/selector.html#attribute-selectors):

```{r}
tagQ <- tagQuery(div(div(), div("data-foo" = "bar")))
# The moral equivalent to `tagQ$find("[data-foo]")`
tagQ$
  find("*")$
  filter(function(x, i) tagHasAttribute(x, "data-foo"))$
  selected()
```

### Reset

To reset the set of selected tags to the root tag, use `$resetSelected()`:

```{r}
tagQ <- tagQuery(div(a()))$find("a")
tagQ$selected()
tagQ$resetSelected()$selected()
```


## Modify {#modify}

`tagQuery()` provides numerous functions for modifying HTML [attributes](#modify-attrs), [children](#modify-child), or [sibling](#modify-sibling) tags of the current query selection. Unlike query methods, modifier methods _modify their input_ (both the root and the selection). For example, note how the `$addClass()` call here modifies `tagQ` (but `$find()` doesn't):

```{r}
tagQ <- tagQuery(div(a()))
tagQ$find("a")$addClass("foo")
tagQ
```

The [mutable](https://en.wikipedia.org/wiki/Immutable_object) behavior of modifier methods not only allows us to modify child tags without losing a reference to the root tag, but it also makes modifications more  [performant](#performance) than they'd otherwise be.

### Attributes {#modify-attrs}

Use `$addAttrs()` to add and `$removeAttrs()` to remove any HTML attribute from each selected tag. If you're just working with `class` attributes, consider using the more convenient `$addClass()`, `$removeClass()`, or `$toggleClass()`

```{r}
tagQ <- tagQuery(div(span(a()), span()))
tagQ$find("span")$addAttrs("data-bar" = "foo")
tagQ$root()
```

Also, to check whether each selected tag has a certain attribute, use `$hasAttr()` (or `$hasClass()`)

```{r}
tagQ$find("span")$hasAttr("data-bar")
```

### Children {#modify-child}

Use `$prepend()` to insert content before the children of each selected tag and `$append()` to insert content after:

```{r}
tagQ <- tagQuery(div(p(a())))
tagQ$find("p")$prepend(span())$append(tags$table())
tagQ$root()
```

If you'd like to replace all the children, then you can first call `$empty()` before `$append()`. If you like to just remove particular child elements, then you should call `$children()` + the `$remove()` sibling method.

### Siblings {#modify-sibling}

Use `$before()` to insert content before each selected tag and `$after()` to insert content after:

```{r}
tagQ <- tagQuery(div(p(a())))
tagQ$find("a")$before(span())$after(tags$table())
tagQ$root()
```

## Replace {#replace}

As with `tagQuery()`'s modifier methods, its replace methods also modify their input. They also empty selected tags, so you may want to `$resetSelection()` if you want to make more queries or modifications after-the-fact. 

Use `$replaceWith()` to replace selected tags with some other content.

```{r}
tagQ <- tagQuery(div(a()))
tagQ$find("a")$replaceWith(p())
tagQ
```

Use `$remove()` to replace selected tags with nothing:

```{r}
tagQ <- tagQuery(div(a()))
tagQ$find("a")$remove()
tagQ
```

And use `$empty()` to replace the _children_ of the selected tags with nothing:

```{r}
tagQ <- tagQuery(div(span(a())))
tagQ$find("span")$empty()
tagQ
```


<!--
## Performance {#performance}

TODO: barret to fill this in
-->
