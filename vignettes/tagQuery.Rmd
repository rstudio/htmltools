---
title: "Using tagQuery() to query and modify HTML tags"
output: html_document
---

```{r, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  out.width = "100%",
  fig.align = 'center'
)
```

`tagQuery()` provides a [jQuery](https://jquery.com) inspired interface to query and/or modify HTML fragments in R. To start, pass either a `tag()` (e.g., `div()`) or `tagList()` object to `tagQuery()`:

```{r}
library(htmltools)
tagQuery(div(a()))
```

Notice how `tagQuery()` tracks two essential pieces: the _root_ (i.e., input) tag as well as a set of _selected_ tags (by default the root is selected). This data structure allows us to [efficiently](#performance) [query](#query) and [modify](#modify) particular fragments of the root HTML tag.

Since `tagQuery()` isn't itself a `tag()` object, it can't be passed directly to `tag()` or tag rendering functions, but at any given time you can extract the `$root()` or `$selected()` tags.

## Query {#query}

`tagQuery()` has numerous methods to select (i.e., query) HTML tag(s). Every query method accepts a [CSS selector](https://developer.mozilla.org/en-US/docs/Learn/CSS/Building_blocks/Selectors) for targeting particular tags of interest. At the moment, `tagQuery()` only supports a combination of [type](https://www.w3.org/TR/CSS22/selector.html#type-selectors) (e.g, `div`), [class](https://www.w3.org/TR/CSS22/selector.html#class-html) (e.g., `.my-class`), [id](https://www.w3.org/TR/CSS22/selector.html#id-selectors) (e.g., `#myID`), and [universal](https://www.w3.org/TR/CSS22/selector.html#universal-selector) (`*`) selectors within a given [simple selector](https://www.w3.org/TR/CSS22/selector.html#selector-syntax).

### Children

To begin querying tags, start with either `$find()` or `$children()`. The former traverses _all_ descendants whereas the latter only considers _direct_ descendants.

```{r}
tagQ <- tagQuery(div(span("foo"), div(span("bar"))))
tagQ$find("span")$selected()
tagQ$children("span")$selected()
```

And since `$find()` considers all descendants, it allows for [descendant selectors](https://www.w3.org/TR/CSS22/selector.html#descendant-selectors) (space) and direct [child selectors](https://www.w3.org/TR/CSS22/selector.html#child-selectors) (>).

```{r}
tagQ <- tagQuery(div(div(span(a()))))
tagQ$find("div a")$selected()
tagQ$find("div > a")$selected()
tagQ$find("div > span > a")$selected()
```

Since `tagQuery()` methods may be chained together, you could also implement  `tagQ$find("div > span > a")` as:

```{r}
tagQ$find("div")$children("span")$children("a")$selected()
```

### Siblings

Although `tagQuery()` doesn't (currently) support [sibling selectors](https://www.w3schools.com/css/css_combinators.asp) (`+` and `~`), it does provide a `$sibling()` method, which provides essentially the same functionality:

```{r}
tagQ <- tagQuery(div(a(), span(), p()))
# morally equivalent to `tagQ$find("a ~ span")`
tagQ$find("a")$siblings("span")$selected()
```

### Parents

In some cases, after finding children, it can be useful to traverse back up the tag tree to find particular ancestors of a selection. Similar to the difference in `$find()` and `$children()`, `$parents()` traverses _all_ ancestors whereas `$parent()` considers just _direct_ ancestors.

```{r}
tagQ <- tagQuery(
  div(
    div(a(class = "foo")),
    span(a())
  )
)
tagQ$find("a.foo")$parent()$selected()
tagQ$find("a.foo")$parents()$selected()
```

<!-- TODO: worth mentioning closest()? -->

### Filter

The `$filter()` method can be used to subset selected tags using an R function or CSS selector. When combined with the universal selector (`*`), `$filter()` is particularly useful as a workaround for the fact that `tagQuery()` doesn't fully support the entire CSS selector specification. For example, here's a workaround for `tagQuery()`'s currenty lack of support for [attribute selectors](https://www.w3.org/TR/CSS22/selector.html#attribute-selectors):

```{r}
tagQ <- tagQuery(div(div(), div("data-foo" = "bar")))
# moral equivalent to `tagQ$find("[data-foo]")`
tagQ$
  find("*")$
  filter(function(x, i) tagHasAttribute(x, "data-foo"))$
  selected()
```


## Modify {#modify}

### Mutation

In contrast to other functions in `{htmltools}` designed to modify `tag()`s (e.g., `tagAppendAttributes()`, `tagAppendChild()`, etc), `tagQuery()`'s modifier methods (e.g., `$addClass()`) _modify their input_:

```{r}
tagQ$addClass("foo")
tagQ
```

As we'll see in [Query](#query), the [mutable](https://developer.mozilla.org/en-US/docs/Glossary/Mutable) nature of `tagQuery()`'s modifier methods enables [efficient](#performance) modification of child tags without losing a reference to the root tag.

### Attributes

`tagQuery()` has numerous methods for modifying attributes

```{r}
tagQ$addAttrs("data-bar" = "foo")
tagQ
```

### Children

TODO: useful example(s)

### Siblings

TODO: useful example(s)



## Extract {#extract}

Since `tagQuery()` objects represent both a root tag and a set of selected tags, you'll need to decide whether you want the root or selection via `$asTags()` when trying to use it inside other functions like `tag()`, `tagList()`, or `renderTags()`

```{r}
tags$body(
  tagQ$asTags()
)
```


## Performance {#performance}

TODO: barret, fill this in!
